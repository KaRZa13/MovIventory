name: EAS Build & Release APK

permissions:
  contents: write

on:
  push:
    branches: [ 'main' ]
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Install dependencies
        run: npm install

      - name: Build with EAS
        id: eas_build
        env:
          EAS_TOKEN: ${{ secrets.EAS_TOKEN }}
        run: |
          sudo apt-get install -y jq 
          export EXPO_TOKEN=${{ secrets.EAS_TOKEN }} 
          
          # Lance un build distant et capture l'ID
          BUILD_ID=$(eas build -p android --profile preview --non-interactive --json | jq -r '.[0].id') 
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV 
          
          # Attend la fin du build et récupère l'URL du fichier .apk 
          DOWNLOAD_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl') 
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV 

      - name: Download APK
        run: |
          curl -L ${{ env.DOWNLOAD_URL }} -o app-release.apk 
          
      - name: Generate and push new tag
        id: tag_step
        run: |
          # Nouveau tag basé sur la date
          NEW_TAG="v$(date +'%Y.%m.%d.%H%M%S')"
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
          echo "tag_name=$NEW_TAG" >> $GITHUB_OUTPUT

          # Récupérer l'ancien tag (le plus récent)
          OLD_TAG=$(git tag --sort=-creatordate | head -n 1)

          echo "Old tag : $OLD_TAG"
          echo "New tag : $NEW_TAG"

          # Supprimer l'ancien tag s'il existe
          if [ ! -z "$OLD_TAG" ]; then
            git push origin --delete "$OLD_TAG" || true
          fi

          # Créer et pousser le nouveau tag
          git tag "$NEW_TAG"
          git push origin "$NEW_TAG"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.tag_name }}
          files: app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}